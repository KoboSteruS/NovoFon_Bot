# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–í–æ–ø—Ä–æ—Å:** –°–º–æ–∂–µ—Ç –ª–∏ –±–æ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ –∏–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑?

**–û—Ç–≤–µ—Ç:** –ö–æ–¥ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥, –Ω–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—â–µ–π.

## –ö–∞–∫ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –¥–∏–∞–ª–æ–≥

```
1. –ë–æ—Ç –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–æ–¥–∏–Ω —Ä–∞–∑) ‚úÖ
   ‚Üì
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç —á—Ç–æ-—Ç–æ
   ‚Üì
3. Snoop channel –ø–æ–ª—É—á–∞–µ—Ç RTP ‚Üí ChannelMediaReceived event
   ‚Üì
4. –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞—É–¥–∏–æ –≤ ElevenLabs ASR
   ‚Üì
5. ASR –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç ‚Üí _handle_user_speech()
   ‚Üì
6. FSM –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚Üí processor.speak() (–æ—Ç–≤–µ—Ç)
   ‚Üì
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ª—ã—à–∏—Ç –æ—Ç–≤–µ—Ç ‚úÖ
   ‚Üì
8. –¶–∏–∫–ª –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è (—à–∞–≥–∏ 2-7)
```

## –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Asterisk –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ChannelMediaReceived —Å–æ–±—ã—Ç–∏—è

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ë–æ—Ç –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç, –Ω–æ –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç
- –í –ª–æ–≥–∞—Ö –Ω–µ—Ç `ChannelMediaReceived` —Å–æ–±—ã—Ç–∏–π

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –í –ª–æ–≥–∞—Ö –±–æ—Ç–∞ –∏—â–∏—Ç–µ:
grep "ChannelMediaReceived" logs/app.log
grep "Media received from channel" logs/app.log
grep "Sent.*bytes of.*audio to processor" logs/app.log
```

**–ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–π –Ω–µ—Ç:**
- Asterisk –º–æ–∂–µ—Ç –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å `ChannelMediaReceived` –¥–ª—è snoop channels –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–æ–¥—Ö–æ–¥ (—Å–º. –Ω–∏–∂–µ)

### –ü—Ä–æ–±–ª–µ–º–∞ 2: ASR –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã

**–°–∏–º–ø—Ç–æ–º—ã:**
- –í –ª–æ–≥–∞—Ö –µ—Å—Ç—å `ChannelMediaReceived` —Å–æ–±—ã—Ç–∏—è
- –í –ª–æ–≥–∞—Ö –µ—Å—Ç—å "Sent X bytes of audio to processor"
- –ù–æ –Ω–µ—Ç "Transcript:" –∏–ª–∏ "User said:"

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –í –ª–æ–≥–∞—Ö –±–æ—Ç–∞ –∏—â–∏—Ç–µ:
grep "Transcript:" logs/app.log
grep "User said:" logs/app.log
grep "final_transcript" logs/app.log
```

**–ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤ –Ω–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ElevenLabs ASR
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∞—É–¥–∏–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è (PCMU ‚Üí PCM16)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ ASR –ø–æ–ª—É—á–∞–µ—Ç –∞—É–¥–∏–æ

### –ü—Ä–æ–±–ª–µ–º–∞ 3: FSM –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Ä–µ–ø–ª–∏–∫–∏

**–°–∏–º–ø—Ç–æ–º—ã:**
- –í –ª–æ–≥–∞—Ö –µ—Å—Ç—å "User said: ..."
- –ù–æ –Ω–µ—Ç "=== SPEAK ===" –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –í –ª–æ–≥–∞—Ö –±–æ—Ç–∞ –∏—â–∏—Ç–µ:
grep "=== SPEAK ===" logs/app.log
grep "Processing input in state" logs/app.log
```

**–ï—Å–ª–∏ –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏–∫—É FSM
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `_handle_user_speech()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è

## –ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏
journalctl -u novofon-bot -f

# –ò–ª–∏ –µ—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ –≤—Ä—É—á–Ω—É—é:
python -m app.main
```

### –®–∞–≥ 2: –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –±–æ—Ç—É –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏

**–ß—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:**

1. **–ü—Ä–∏ –∑–≤–æ–Ω–∫–µ:**
```
‚úÖ Snoop channel started: <snoop_id> for channel <channel_id>
‚úÖ Voice processing started for channel <channel_id>
=== SPEAK ===
Text: –ê–ª–ª–æ? –ú–µ–Ω—è —Å–ª—ã—à–Ω–æ?
```

2. **–ö–æ–≥–¥–∞ –≤—ã –≥–æ–≤–æ—Ä–∏—Ç–µ:**
```
ChannelMediaReceived event (–∏–ª–∏ Media received from channel)
Sent X bytes of pcmu audio to processor
Transcript: <–≤–∞—à —Ç–µ–∫—Å—Ç>
User said (<channel_id>): <–≤–∞—à —Ç–µ–∫—Å—Ç>
Processing input in state...
=== SPEAK ===
Text: <–æ—Ç–≤–µ—Ç –±–æ—Ç–∞>
```

3. **–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ —à–∞–≥ 1, –Ω–æ –Ω–µ—Ç —à–∞–≥–∞ 2:**
   - –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–ª—É—á–µ–Ω–∏–µ–º RTP –∞—É–¥–∏–æ (—Å–º. –ü—Ä–æ–±–ª–µ–º–∞ 1)

## –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å ChannelMediaReceived

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Asterisk

Asterisk –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å —è–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ media —Å–æ–±—ã—Ç–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é Asterisk:

```bash
asterisk -rx "core show version"
```

–î–ª—è Asterisk 16+ –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `externalMedia` –≤–º–µ—Å—Ç–æ `snoop`.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å externalMedia (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ snoop)

–ï—Å–ª–∏ `snoop` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `externalMedia`:

```python
# –í asterisk_call_handler.py –≤–º–µ—Å—Ç–æ snoop_channel:
external_media = await self.ari.external_media(
    app=self.ari.app_name,
    channel_id=channel_id,
    external_host="127.0.0.1:5004",  # –õ–æ–∫–∞–ª—å–Ω—ã–π RTP —Å–µ—Ä–≤–µ—Ä
    format="slin16"
)
```

–ù–æ —ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ RTP —Å–µ—Ä–≤–µ—Ä–∞.

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ARI Recording

–ú–æ–∂–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –∫–∞–Ω–∞–ª –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–ø–∏—Å—å:

```python
# –ó–∞–ø–∏—Å—å –∫–∞–Ω–∞–ª–∞
recording = await self.ari.start_recording(
    channel_id=channel_id,
    name=f"call_{channel_id}",
    format="wav"
)

# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
# (–Ω–æ —ç—Ç–æ –Ω–µ real-time)
```

## –¢–µ–∫—É—â–∏–π –∫–æ–¥ - —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ

‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç:**
- –°–æ–∑–¥–∞–Ω–∏–µ snoop channel
- –û–±—Ä–∞–±–æ—Ç–∫–∞ `ChannelMediaReceived` —Å–æ–±—ã—Ç–∏–π
- –û—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ –≤ ASR
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ FSM
- TTS –∏ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ

‚ùì **–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- –î–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ Asterisk –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `ChannelMediaReceived` –¥–ª—è snoop channels
- –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ ASR –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ª–∏ FSM –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ —Ä–µ–ø–ª–∏–∫–∏

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. –í–∫–ª—é—á–∏—Ç–µ DEBUG –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í `.env` –∏–ª–∏ `app/config.py`:
```python
log_level = "DEBUG"
```

### 2. –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –ª–æ–≥–æ–≤ –≤ –∫–æ–¥

–í `asterisk_call_handler.py`, –º–µ—Ç–æ–¥ `_on_media_received`:
```python
async def _on_media_received(self, event: Dict):
    logger.info(f"üîä ChannelMediaReceived event received!")  # ‚Üê –î–æ–±–∞–≤–∏—Ç—å
    logger.info(f"Event data: {event}")  # ‚Üê –î–æ–±–∞–≤–∏—Ç—å
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–±—ã—Ç–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ ARI WebSocket –≤—Ä—É—á–Ω—É—é –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è
# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ARI CLI:
curl -u username:password http://asterisk:8088/ari/events?app=novofon_bot
```

## –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç

**–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –±–æ—Ç –±—É–¥–µ—Ç –≥–æ–≤–æ—Ä–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑**, –µ—Å–ª–∏:

1. Asterisk –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `ChannelMediaReceived` —Å–æ–±—ã—Ç–∏—è –¥–ª—è snoop channels
2. –ò–ª–∏ ASR –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ

**–ß—Ç–æ–±—ã —Ç–æ—á–Ω–æ —É–∑–Ω–∞—Ç—å:**
1. –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –±–æ—Ç—É
2. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –µ—Å—Ç—å –ª–∏ `ChannelMediaReceived` —Å–æ–±—ã—Ç–∏—è –∫–æ–≥–¥–∞ –≤—ã –≥–æ–≤–æ—Ä–∏—Ç–µ
4. –ï—Å–ª–∏ –Ω–µ—Ç - –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–æ–¥—Ö–æ–¥ (externalMedia –∏–ª–∏ recording)

**–ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏—è –µ—Å—Ç—å, –Ω–æ –±–æ—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ASR –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ FSM –ª–æ–≥–∏–∫—É
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤



